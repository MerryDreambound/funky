<script lang="ts">
  import { SlideToggle } from '@skeletonlabs/skeleton'
  import games from 'shared/games'
  import {
    isDraggingAddon,
    libraryActiveSubCategories,
    libraryActiveCategory
  } from '../../stores/library'
  import { db } from '../../db/db'
  import { activeProfileStore } from '../../stores/active-profile'
  import { toggleAddonIdInShuffle, toggleShuffleEnabled } from '../../utils/shuffles'
  import { liveQuery } from 'dexie'
  import { currentGameManifest } from '../../stores/manifest'
  import AddonCard from '../addons/AddonCard.svelte'

  const subCategory = $libraryActiveSubCategories[0] ?? undefined

  const shuffle = liveQuery(() => {
    return db.shuffles
      .where('autoGeneratedForProfileId')
      .equals($activeProfileStore.id)
      .and((shuffle) => {
        return shuffle.autoGeneratedForSubCategory === subCategory
      })
      .first()
  })

  $: shuffleEnabled = $activeProfileStore.enabledShuffleIds.includes($shuffle?.id)

  async function createOrEnableSubCategoryShuffle() {
    // Create the shuffle if it doesn't exist already
    if (!$shuffle) {
      const newShuffle = await db.shuffles.add({
        shuffledAddonIds: [],
        label: subCategory,
        autoGeneratedForProfileId: $activeProfileStore.id,
        autoGeneratedForSubCategory: subCategory
      })

      console.log('created auto-generated subCategory shuffle', newShuffle)

      // Enable new shuffle
      toggleShuffleEnabled(newShuffle)
      return
    } else {
      // Enable existing shuffle
      toggleShuffleEnabled($shuffle.id)
    }
  }

  function handleSubCategoryShuffleToggle() {
    if (!shuffleEnabled) createOrEnableSubCategoryShuffle()
    else toggleShuffleEnabled($shuffle.id)
  }

  function drop(event: DragEvent) {
    console.log(event)
    $isDraggingAddon = false
    const json = event.dataTransfer.getData('text/plain')
    const data = JSON.parse(json)

    if ($libraryActiveSubCategories.length == 0) return
    toggleAddonIdInShuffle($shuffle.id, data.addonId)

    event.preventDefault()
  }
</script>

<div class="z-10 flex-1 fixed left-[250px] bottom-0 right-0 flex items-end w-full">
  <div
    class:inactive={!shuffleEnabled}
    on:dragover={(ev) => {
      ev.preventDefault()
    }}
    on:drop={(e) => drop(e)}
    class:dropActive={$isDraggingAddon}
    class="transition-transform min-h-[162px] fixed left-[250px] right-0 z-10 py-2 after:h-[1px] after:left-[-2px] after:absolute after:top-[-2px] after:w-full after:bg-surface-700 after:content-[''] after:border-white mx-3 bg-surface-900/50 backdrop-blur-md border-2 border-transparent border-dotted"
  >
    <div class="">
      {#if $libraryActiveSubCategories.length == 1}
        {@const activeGameData = games[550]}
        {@const activeSubCat = activeGameData.addons.categories
          .find((cat) => cat.id == $libraryActiveCategory)
          ?.subCategories.find((subCat) => subCat.id == $libraryActiveSubCategories[0])}

        {#if activeSubCat.allowSingleAddonRandomization}
          <div class="px-3 py-1">
            <SlideToggle
              active="bg-emerald-500"
              name=""
              on:click={handleSubCategoryShuffleToggle}
              checked={shuffleEnabled}>Shuffle mode</SlideToggle
            >
          </div>

          <div class="flex gap-2 p-2 w-full overflow-x-scroll" class:grayscale={!shuffleEnabled}>
            {#each $shuffle?.shuffledAddonIds ?? [] as addonId}
              {@const addonData = $currentGameManifest.addons.find((addon) => addon.id == addonId)}
              {#if addonData}
                <AddonCard mode="card" asShuffle addon={addonData} />
              {/if}
            {/each}

            {#if $shuffle?.shuffledAddonIds.length == 0}
              <div class="text-center text-gray-400">Drag and drop addons here to shuffle them</div>
            {/if}
          </div>
        {/if}
      {/if}
    </div>
  </div>
</div>

<style lang="postcss">
  .dropActive {
    @apply outline-1  outline-dashed outline-primary-500;
  }

  .inactive {
    @apply translate-y-[104px];
  }
</style>
